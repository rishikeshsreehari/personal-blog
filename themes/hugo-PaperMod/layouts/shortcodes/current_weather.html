<span id="temperature">Loading...</span>

<script async>
  const el = document.getElementById("temperature");
  const loc = "{{ .Site.Params.CurrentLocation | urlize }}";

  const map = {
    "ðŸŒ‘": "It's a new moon ðŸŒ‘, so the sky will be dark tonight.",
    "ðŸŒ’": "At night, a sliver of the moon is visible ðŸŒ’.",
    "ðŸŒ“": "At night, half of the moon is visible ðŸŒ“.",
    "ðŸŒ”": "At night, the moon is almost full ðŸŒ”.",
    "ðŸŒ•": "It's a full moon ðŸŒ•, illuminating the night sky.",
    "ðŸŒ–": "The moon is starting to wane ðŸŒ–, but still mostly visible.",
    "ðŸŒ—": "At night, half of the moon is visible ðŸŒ—.",
    "ðŸŒ˜": "A small crescent of the moon is visible tonight ðŸŒ˜."
  };

  // Convert Celsius to Fahrenheit and km/h to mph
  const toF = c => (c * 9/5 + 32).toFixed(1);
  const toMph = k => (k * 0.621371).toFixed(1);

  async function fetchWeather() {
    try {
      const res = await fetch(`https://wttr.in/${loc}?format=%C+%t+%h+%w+%m`);
      const [cond, tempC, hum, wind, moon] = (await res.text()).split(" ");
      
      const windSpeed = wind.replace(/[^\d.]/g, ''); // Extract only the numbers for wind
      const tempF = toF(parseFloat(tempC.replace('Â°C', '')));
      const windMph = toMph(parseFloat(windSpeed));
      const moonDesc = map[moon] || `The moon phase tonight is ${moon}.`;
      
      el.innerHTML = `Here it's ${cond.toLowerCase()} with a temperature of <strong>${tempC}</strong> (<strong>${tempF}Â°F</strong>). The humidity is <strong>${hum}</strong>, and the wind is blowing at <strong>${wind}</strong> (<strong>${windMph} mph</strong>). ${moonDesc}`;
    } catch (e) {
      el.textContent = 'Failed to fetch temperature';
    }
  }

  fetchWeather();
</script>
