{{ if not .Params.disable_comments }}
<h1>Comments</h1>

<!-- Existing comment display code remains unchanged -->

<div class="comments-section">
  {{ $url := .Params.url }} <!-- Get the permalink (URL) of the current page -->
  {{ $url = trim $url "/" }} 
  {{ $commentsPath := "data/comments.json" }} <!-- Set the path to the comments JSON file -->
  {{ $commentsData := getJSON $commentsPath | default (dict) }} <!-- Load the comments data or set default empty dictionary if error occurs -->
  {{ with index $commentsData $url }} <!-- Retrieve comments for the current page -->
    {{ $comments := . | default (slice) }} <!-- Assign comments data for the current page to $comments variable, using a default empty slice if error occurs -->
    {{ if gt (len $comments) 0 }} <!-- Check if comments are not empty -->
      {{ range $comments }} <!-- Iterate over the comments -->
        <div class="comment {{ if in .Comment "author-marker" }}highlight{{ end }}">
          <div class="avatar">
            <img src="https://api.dicebear.com/7.x/identicon/svg?seed={{ .Name }}" alt="avatar">
          </div>
          <div class="comment-details">
            <strong class="comment-author-name">{{ .Name }}</strong><span class="date">on {{ .Date }}</span>
            {{ if in .Comment "author-marker" }}<span class="author-reply-label">Author Reply</span>{{ end }}
            <p>{{ .Comment | safeHTML }}</p>
          </div>
        </div>
      {{ end }}
    {{ else }}
      <p>No comments yet.</p>
    {{ end }}
  {{ else }}
    <p>No comments yet.</p>
  {{ end }}
</div>

<br>

<h5>Leave a comment below. All comments are moderated and will appear after approval. Your email, if provided, is optional and won't be shared or used to send any spam. If your comment requires a personal response beyond a public reply, I will reach out to you via email. Comments are static, with no notifications or backlinks.
</h5>
<br>

<form 
  id="commentForm" 
  method="POST" 
  action="https://script.google.com/macros/s/AKfycbybzIVhZ6DyJQD8nl0suisVDVly07c87524X84iORIBdkekzQ68ugrCG8TrTB5HnJdtuQ/exec">
  <div class="comment-form">
    <input type="hidden" name="timestamp" id="timestamp" value="" />
    <input type="hidden" name="url" value="{{ .Params.url }}" />
    <!-- Hidden input for Turnstile token -->
    <input type="hidden" name="cf-turnstile-response" id="cf-turnstile-response" />

    <div class="form-row">
      <div class="column">
        <label for="name">Name</label>
        <input type="text" id="name" name="name" required placeholder="Tibetan Yeti" />
      </div>
      <div class="column">
        <label for="email">Email [optional]</label>
        <input type="email" id="email" name="email" placeholder="tibetanyeti@example.com" />
      </div>
    </div>

    <!-- Honeypot field -->
    <div style="display:none;">
      <label>If you're a human, leave this field blank!<input type="text" name="honeypot" /></label>
    </div>

    <div class="form-row">
      <label for="message">Comment</label>
      <textarea id="message" name="message" required placeholder="Leave a message for the Yeti, they might be reading!"></textarea>
    </div>

    <!-- Turnstile widget with callback -->
    <div class="cf-turnstile" data-sitekey="0x4AAAAAAAxKySDyC3zOb0zW" data-callback="onTurnstileCallback"></div>

    <div class="form-row">
      <button type="submit" id="submitBtn">Comment</button>
    </div>

    <!-- Spinner -->
    <div id="loading-spinner" style="display: none; text-align: center; margin-top: 10px;">
      <svg xmlns="http://www.w3.org/2000/svg" style="margin: auto; background: none; display: block;" width="50px" height="50px" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid">
        <circle cx="50" cy="50" r="35" stroke-width="8" stroke="#fff" stroke-dasharray="54.97787143782138 54.97787143782138" fill="none" stroke-linecap="round">
          <animateTransform attributeName="transform" type="rotate" repeatCount="indefinite" dur="1s" values="0 50 50;360 50 50" keyTimes="0;1"></animateTransform>
        </circle>
      </svg>
    </div>

    <!-- Error or Success message container -->
    <div id="message-container" style="color: #DADADB; margin-top: 10px;"></div>
  </div>
</form>

<!-- Include Turnstile script -->
<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

<script>
  // Callback function to receive Turnstile token
  function onTurnstileCallback(token) {
    document.getElementById('cf-turnstile-response').value = token;
  }

  document.getElementById("commentForm").addEventListener("submit", function(event) {
    event.preventDefault(); // Prevent the default form submission

    var answer = document.getElementById("mathAnswer").value;
    var messageContainer = document.getElementById("message-container");
    var loadingSpinner = document.getElementById("loading-spinner");

    // Clear previous messages
    messageContainer.textContent = '';

    // Check if the answer is correct
    if (answer !== "79") {
      messageContainer.textContent = "Incorrect math answer. Please try again.";
      messageContainer.style.color = "red"; // Set the color to red for the error message
      return;
    }

    // Check if Turnstile token is present
    var turnstileToken = document.getElementById('cf-turnstile-response').value;
    if (!turnstileToken) {
      messageContainer.textContent = "Please complete the CAPTCHA challenge.";
      messageContainer.style.color = "red";
      return;
    }

    // Show the spinner
    loadingSpinner.style.display = "block";

    // Get form data
    var formData = new FormData(document.getElementById("commentForm"));

    // Send the form data via fetch (AJAX)
    fetch(document.getElementById("commentForm").action, {
      method: 'POST',
      body: formData,
    })
    .then(response => {
      // Hide the spinner
      loadingSpinner.style.display = "none";

      if (response.ok) {
        messageContainer.textContent = "Your comment has been successfully submitted. Once approved, it will appear here. Thanks!";
        messageContainer.style.color = "green"; // Change color to green for success

        // Reset the form fields
        document.getElementById("commentForm").reset();
        // Reset the Turnstile widget
        turnstile.reset();
      } else {
        throw new Error('Failed to submit');
      }
    })
    .catch(error => {
      // Hide the spinner
      loadingSpinner.style.display = "none";

      messageContainer.textContent = "There was an error submitting your comment. Please try again.";
      messageContainer.style.color = "red"; // Show error in red
    });
  });

  // Set timestamp when form loads
  document.getElementById('timestamp').value = new Date().toISOString();
</script>
{{ end }}
